import smbus
from max30105 import MAX30105, HeartRate
import gpiod

max30105 = MAX30105()
max30105.setup(leds_enable=2)

max30105.set_led_pulse_amplitude(1, 0.2)
max30105.set_led_pulse_amplitude(2, 12.5)
max30105.set_led_pulse_amplitude(3, 0)

max30105.set_slot_mode(1, 'red')
max30105.set_slot_mode(2, 'ir')
max30105.set_slot_mode(3, 'off')
max30105.set_slot_mode(4, 'off')

chip = gpiod.chip('gpiochip0')


config = gpiod.line_request()
config.consumer = "foobar"
config.request_type = gpiod.line_request.DIRECTION_OUTPUT

red = chip.get_lines([16]) # zdrowe
red.request(config)

green = chip.get_lines([21]) # smierc
green.request(config)

blue = chip.get_lines([20]) # niezdrowe
blue.request(config)

def display_heartrate(beat, bpm, avg_bpm):
    print("{} BPM: {:.2f}  AVG: {:.2f}".format("<3" if beat else "  ",
          bpm, avg_bpm))
    manage_leds(beat, bpm, avg_bpm)
    display_temp();

def manage_leds(beat, bpm, avg_bpm):
    if ((bpm <50 and bpm > 10) or bpm > 100):
        blue.set_values([1])
        red.set_values([0])
        green.set_values([0])
    if bpm >= 50 and bpm <= 100:
        blue.set_values([0])
        red.set_values([1])
        green.set_values([0])
    if bpm <= 10:
        blue.set_values([0])
        red.set_values([0])
        green.set_values([1])

def display_temp():
    print("   Temperature: ", max30105.get_temperature(), " *C")

hr = HeartRate(max30105)

delay = 10

# print("Starting readings in {} seconds...\n".format(delay))
# time.sleep(delay)

try:
    hr.on_beat(display_heartrate, average_over=4)
except KeyboardInterrupt:
    pass






















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































print("o tam byczq???")